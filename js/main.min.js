var debugmode=!1,sounds=!1,dialogOpened=!0,states=Object.freeze({SplashScreen:0,GameScreen:1,ScoreScreen:2}),currentstate,gravity=.25,velocity=0,position=180,rotation=0,jump=-4.6,score=0,highscore=0,pipes=[],catchers=[],shields=[],scoreTime=0,replayclickable=!1,shieldActivated=!1,turboActivated=!1,hardcore=!1,volume=30,soundJump=new buzz.sound("assets/sounds/rocket.ogg"),soundScore=new buzz.sound("assets/sounds/sfx_point.ogg"),soundHit=new buzz.sound("assets/sounds/sfx_hit.ogg"),soundDie=new buzz.sound("assets/sounds/sfx_die.ogg"),soundSwoosh=new buzz.sound("assets/sounds/sfx_swooshing.ogg");buzz.all().setVolume(volume);var fuel=$("#fuel"),overalWidth=fuel.width(),halfHeight=.5*overalWidth,minimumHeight=.2*overalWidth,fuelToDown=.03*fuel.width(),loopGameloop,loopPipeloop,loopFuel,loopCatchers,loopShields;$(document).ready(function(){function e(e){for(var t=e+"=",o=document.cookie.split(";"),i=0;i<o.length;i++){var n=o[i].trim();if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}function t(e,t,o){var i=new Date;i.setTime(i.getTime()+24*o*60*60*1e3);var n="expires="+i.toGMTString();document.cookie=e+"="+t+"; "+n}function o(){currentstate=states.SplashScreen,velocity=0,position=180,rotation=0,score=0,$("#player").css({y:0,x:0}),n($("#player")),sounds&&(soundSwoosh.stop(),soundSwoosh.play()),$(".fuel").remove(),$(".catch").remove(),pipes=[],catchers=[],$(".animated").css("animation-play-state","running"),$(".animated").css("-webkit-animation-play-state","running"),$("#splash").transition({opacity:1},2e3,"ease")}function i(){fuel.css("background-color","#18f669"),fuel.width(overalWidth),currentstate=states.GameScreen;for(var e=$(".shield-dog"),t=e.length;3>t;t++){var o=$('<img src="assets/shield-up.png" class="shield-dog" width="25" style="margin-left: 5px;" />');$("#shield-handler").append(o)}$("#splash").stop(),$("#splash").transition({opacity:0},500,"ease"),p(),debugmode&&$(".boundingbox").show();var i=1e3/60;loopGameloop=setInterval(a,i),loopPipeloop=setInterval(y,3e3),loopCatchers=setInterval(w,2e3),loopFuel=setInterval(S,1e3),loopShields=setInterval(b,3e4),u(),setInterval(function(){scoreTime++},1e3)}function n(e){rotation=Math.min(velocity/35*90,90),$(e).css({rotate:rotation,top:position})}function s(){turboActivated=!0;var e=$(".fuel"),t=$(".catch");e.css("-webkit-animation","animPipe 1000ms linear"),t.css("-webkit-animation","animPipe 100ms linear"),e.css("animation","animPipe 100ms linear"),t.css("animation","animPipe 100ms linear"),setTimeout(function(){e.css("-webkit-animation","animPipe 7500ms linear"),t.css("-webkit-animation","animPipe 7500ms linear"),e.css("animation","animPipe 7500ms linear"),t.css("animation","animPipe 7500ms linear"),turboActivated=!1},3e3)}function a(){var e=$("#player");velocity+=gravity,position+=velocity,n(e);var t=document.getElementById("player").getBoundingClientRect(),o=110,i=81,s=o-8*Math.sin(Math.abs(rotation)/90),a=(i+t.height)/2,l=(t.width-s)/2+t.left,h=(t.height-a)/2+t.top;if(debugmode){var u=$("#playerbox");u.css("left",l),u.css("top",h),u.css("height",a),u.css("width",s)}if(shieldActivated){var u=$("#playershield");u.show(),u.css("left",l-4),u.css("top",h+4),u.css("height",a+4),u.css("width",s+4)}if(t.bottom>=$("#land").offset().top&&m(),fuel.width()<=0&&m(),pipes.length>0)for(var p in pipes){var f=pipes[p];if("undefined"!=typeof f[0]){var g=f[0].getBoundingClientRect();d(t,g)&&(f.remove(),k(),c())}}if(catchers.length>0)for(var p in catchers){var v=catchers[p];if("undefined"!=typeof v[0]){var y=v[0].getBoundingClientRect();d(y,t)&&!shieldActivated&&m(),d(y,t)&&shieldActivated&&v.remove()}}if(shields.length>0)for(var p in shields){var w=shields[p];if("undefined"!=typeof w[0]){var b=w[0].getBoundingClientRect();d(b,t)&&(r(),w.remove())}}}function r(){var e=$('<img src="assets/shield-up.png" class="shield-dog" width="25" style="margin-left: 5px;" />');$("#shield-handler").append(e)}function l(){if(currentstate==states.GameScreen){var e=$(".shield-dog");if("undefined"!=typeof e&&e.length&&e.length>0){e[e.length-1].remove();var t=document.getElementById("player").getBoundingClientRect(),o=110,i=81,n=o-8*Math.sin(Math.abs(rotation)/90),s=(i+t.height)/2,a=(t.width-n)/2+t.left,r=(t.height-s)/2+t.top,l=$("#playershield");l.show(),l.css("left",a-4),l.css("top",r+4),l.css("height",s+4),l.css("width",n+4),shieldActivated=!0,setTimeout(function(){l.hide(),shieldActivated=!1},5e3)}}}function c(){if(x)if(score>50){var e=fuel.width()-.1*overalWidth;e>=overalWidth?fuel.width(overalWidth):fuel.width(e)}else{var e=fuel.width()+.1*overalWidth;e>=overalWidth?fuel.width(overalWidth):fuel.width(e)}else{var e=fuel.width()+.1*overalWidth;e>=overalWidth?fuel.width(overalWidth):fuel.width(e)}}function d(e,t){return!(t.left>e.right||t.right<e.left||t.top>e.bottom||t.bottom<e.top)}function h(){currentstate==states.GameScreen?u():currentstate==states.SplashScreen&&i()}function u(){velocity=jump,sounds&&(soundJump.stop(),soundJump.play())}function p(e){var t=$("#bigscore");if(t.empty(),!e)for(var o=score.toString().split(""),i=0;i<o.length;i++)t.append("<img src='assets/font_big_"+o[i]+".png' alt='"+o[i]+"'>")}function f(){var e=$("#currentscore");e.empty();for(var t=score.toString().split(""),o=0;o<t.length;o++)e.append("<img src='assets/font_small_"+t[o]+".png' alt='"+t[o]+"'>")}function g(){var e=$("#highscore");e.empty();for(var t=highscore.toString().split(""),o=0;o<t.length;o++)e.append("<img src='assets/font_small_"+t[o]+".png' alt='"+t[o]+"'>")}function m(){pipes=[],catchers=[],$(".animated").css("animation-play-state","paused"),$(".animated").css("-webkit-animation-play-state","paused");var e=$("#player").position().top+$("#player").width(),t=$("#flyarea").height(),o=Math.max(0,t-e);$("#player").transition({y:o+"px",rotate:90},1e3,"easeInOutCubic"),currentstate=states.ScoreScreen,clearInterval(loopGameloop),clearInterval(loopPipeloop),clearInterval(loopFuel),clearInterval(loopCatchers),clearInterval(loopShields),loopGameloop=null,loopPipeloop=null,loopCatchers=null,loopFuel=null,loopShields=null,score*=Math.floor(scoreTime/2),W.any()?v():sounds?soundHit.play().bindOnce("ended",function(){soundDie.play().bindOnce("ended",function(){v()})}):v()}function v(){$("#scoreboard").css("display","block"),p(!0),score>highscore&&(highscore=score,t("highscore",highscore,999)),f(),g(),sounds&&(soundSwoosh.stop(),soundSwoosh.play()),$("#scoreboard").css({y:"40px",opacity:0}),$("#replay").css({y:"40px",opacity:0}),$("#scoreboard").transition({y:"0px",opacity:1},600,"ease",function(){sounds&&(soundSwoosh.stop(),soundSwoosh.play()),$("#replay").transition({y:"0px",opacity:1},600,"ease")}),replayclickable=!0}function y(){$(".fuel").filter(function(){return $(this).position().left<=-150}).each(function(){var e=$(this);pipes.splice(e.attr("pipe-id")-pipes.length,1),e.remove()});var e=$("#flyarea").height(),t=e/2,o=Math.floor(Math.random()*e)+1;o>=t?(o-=$("#land").height(),o-=50):o+=$("#fuel").height()+30;var i=$('<div class="fuel animated" id="pipe-'+M++ +'" pipe-id="'+pipes.length+'" style="top: '+o+'px;"></div>');$("#flyarea").append(i),pipes.push(i)}function w(){$(".catch").filter(function(){return $(this).position().left<=-150}).each(function(){var e=$(this);catchers.splice(e.attr("catch-id")-pipes.length,1),e.remove()});var e=$("#flyarea").height(),t=e/2,o=Math.floor(Math.random()*e)+1;o>=t?(o-=$("#land").height(),o-=50):o+=$("#fuel").height()+30;var i=$('<div class="catch animated" id="catch-'+C++ +'" catch-id="'+catchers.length+'" style="top: '+o+'px;"></div>');$("#flyarea").append(i),catchers.push(i)}function b(){$(".shield-up").filter(function(){return $(this).position().left<=-150}).each(function(){var e=$(this);shields.splice(e.attr("shield-id")-pipes.length,1),e.remove()});var e=$("#flyarea").height(),t=e/2,o=Math.floor(Math.random()*e)+1;o>=t?(o-=$("#land").height(),o-=50):o+=$("#fuel").height()+30;var i=$('<div class="shield-up animated" id="shield-'+P++ +'" pipe-id="'+shields.length+'" style="top: '+o+'px;"></div>');$("#flyarea").append(i),shields.push(i)}function S(){x?50>score&&(fuel.width(fuel.width()-fuelToDown),fuel.width()>=halfHeight&&fuel.css("background-color","#18f669"),fuel.width()<=halfHeight&&fuel.css("background-color","#f6f64d"),fuel.width()<=minimumHeight&&fuel.css("background-color","red")):(fuel.width(fuel.width()-fuelToDown),fuel.width()>=halfHeight&&fuel.css("background-color","#18f669"),fuel.width()<=halfHeight&&fuel.css("background-color","#f6f64d"),fuel.width()<=minimumHeight&&fuel.css("background-color","red"))}function k(){score+=1,sounds&&(soundScore.stop(),soundScore.play()),p()}if("?debug"==window.location.search&&(debugmode=!0),"?hardcore"==window.location.search)var x=!0;var A=e("highscore");""!=A&&(highscore=parseInt(A));var O=e("sounds");""!=O?sounds="false"==O?!1:!0:t("sounds",!0),sounds?($("#sound-on").show(),$("#sound-off").hide()):($("#sound-on").hide(),$("#sound-off").show());var I=e("nickname");I&&"anonymous"!=I?dialogOpened=!1:($("#dialog").dialog({dialogClass:"no-close",buttons:[{text:"Save",click:function(){var e=$("#nickname").val();""==e?(t("nickname","Anonymous"),dialogOpened=!1,$(this).dialog("close")):(t("nickname",e),dialogOpened=!1,$(this).dialog("close"))}}]}),dialogOpened=!0),o(),$(document).keydown(function(e){dialogOpened||(66==e.keyCode&&l(),67==e.keyCode&&s(),32==e.keyCode&&(currentstate==states.ScoreScreen?$("#replay").click():h()))}),"ontouchstart"in window?dialogOpened||$(document).on("touchstart",h):dialogOpened||$(document).on("mousedown",h),$("#replay").click(function(){replayclickable&&(replayclickable=!1,sounds&&(soundSwoosh.stop(),soundSwoosh.play()),$("#scoreboard").transition({y:"-40px",opacity:0},1e3,"ease",function(){$("#scoreboard").css("display","none"),o()}))});var M=0,C=0,P=0,W={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Safari:function(){return navigator.userAgent.match(/OS X.*Safari/)&&!navigator.userAgent.match(/Chrome/)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return W.Android()||W.BlackBerry()||W.iOS()||W.Opera()||W.Safari()||W.Windows()}};$(".sound-option").click(function(){var e=$(this).attr("attr");console.log(e),"on"==e?(sounds=!1,t("sounds",!1),$("#sound-on").hide(),$("#sound-off").show()):(sounds=!0,t("sounds",!0),$("#sound-on").show(),$("#sound-off").hide())})});
